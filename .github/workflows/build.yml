name: Build macOS App

on:
  push:
    branches: [main]
  # SECURITY: Do NOT change this to pull_request_target â€” that trigger runs with
  # access to repository secrets, which would expose signing credentials to fork PRs.
  pull_request:
    branches: [main]

jobs:
  build:
    runs-on: macos-latest
    strategy:
      matrix:
        arch: [arm64, universal]
    steps:
      - uses: actions/checkout@v4

      - name: Install create-dmg
        run: brew install create-dmg

      # Import Developer ID certificate when secrets are available (pushes to main).
      # PRs from forks won't have access to secrets, so this step is skipped.
      - name: Import Developer ID certificate
        if: secrets.DEVELOPER_ID_CERTIFICATE_BASE64 != ''
        id: codesign
        env:
          CERTIFICATE_BASE64: ${{ secrets.DEVELOPER_ID_CERTIFICATE_BASE64 }}
          CERTIFICATE_PASSWORD: ${{ secrets.DEVELOPER_ID_CERTIFICATE_PASSWORD }}
        run: |
          CERTIFICATE_PATH="$RUNNER_TEMP/developer_id.p12"
          KEYCHAIN_PATH="$RUNNER_TEMP/signing.keychain-db"
          KEYCHAIN_PASSWORD="$(openssl rand -hex 20)"

          echo "$CERTIFICATE_BASE64" | base64 --decode > "$CERTIFICATE_PATH"

          security create-keychain -p "$KEYCHAIN_PASSWORD" "$KEYCHAIN_PATH"
          security set-keychain-settings -lut 21600 "$KEYCHAIN_PATH"
          security unlock-keychain -p "$KEYCHAIN_PASSWORD" "$KEYCHAIN_PATH"

          security import "$CERTIFICATE_PATH" \
            -P "$CERTIFICATE_PASSWORD" \
            -A \
            -t cert \
            -f pkcs12 \
            -k "$KEYCHAIN_PATH"
          rm -f "$CERTIFICATE_PATH"

          security set-key-partition-list -S apple-tool:,apple:,codesign: \
            -s -k "$KEYCHAIN_PASSWORD" "$KEYCHAIN_PATH"

          security list-keychains -d user -s "$KEYCHAIN_PATH" $(security list-keychains -d user | tr -d '"')

          IDENTITY=$(security find-identity -v -p codesigning "$KEYCHAIN_PATH" | head -1 | sed 's/.*"\(.*\)".*/\1/')
          echo "CODESIGN_IDENTITY=$IDENTITY" >> "$GITHUB_ENV"
          echo "KEYCHAIN_PATH=$KEYCHAIN_PATH" >> "$GITHUB_ENV"
          echo "signed=true" >> "$GITHUB_OUTPUT"

      - name: Fall back to ad-hoc signing
        if: steps.codesign.outputs.signed != 'true'
        run: echo "CODESIGN_IDENTITY=-" >> "$GITHUB_ENV"

      - name: Build
        run: make ARCH=${{ matrix.arch }} APP_NAME=FreeFlow BUNDLE_ID=com.zachlatta.freeflow CODESIGN_IDENTITY="$CODESIGN_IDENTITY"

      - name: Create DMG
        run: make dmg ARCH=${{ matrix.arch }} APP_NAME=FreeFlow BUNDLE_ID=com.zachlatta.freeflow CODESIGN_IDENTITY="$CODESIGN_IDENTITY"

      - name: Sign DMG
        if: steps.codesign.outputs.signed == 'true'
        run: codesign --force --sign "$CODESIGN_IDENTITY" build/FreeFlow.dmg

      - name: Rename DMG
        run: mv build/FreeFlow.dmg build/FreeFlow-${{ matrix.arch }}.dmg

      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: FreeFlow-${{ matrix.arch }}
          path: build/FreeFlow-${{ matrix.arch }}.dmg

      - name: Cleanup signing artifacts
        if: always()
        run: |
          rm -f "$RUNNER_TEMP/developer_id.p12"
          KPATH="${KEYCHAIN_PATH:-$RUNNER_TEMP/signing.keychain-db}"
          if [ -f "$KPATH" ]; then
            security delete-keychain "$KPATH"
          fi
